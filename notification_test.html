<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notification Testing</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-2xl mx-auto space-y-6">
        
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h1 class="text-xl font-bold mb-4">üîî Notification System Test</h1>
            
            <div class="space-y-4">
                <!-- Permission Check -->
                <div class="border-l-4 border-blue-500 pl-4">
                    <h3 class="font-semibold">1. Check Notification Permission</h3>
                    <button id="checkPermission" class="mt-2 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                        Check Permission Status
                    </button>
                    <div id="permissionStatus" class="mt-2 text-sm text-gray-600"></div>
                </div>
                
                <!-- Enable Notifications -->
                <div class="border-l-4 border-green-500 pl-4">
                    <h3 class="font-semibold">2. Enable Notifications</h3>
                    <button id="enableNotifications" class="mt-2 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                        Request Permission & Enable
                    </button>
                </div>
                
                <!-- Test Scenarios -->
                <div class="border-l-4 border-purple-500 pl-4">
                    <h3 class="font-semibold">3. Test Scenarios</h3>
                    <div class="mt-2 space-x-2">
                        <button id="testBasicNotif" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">
                            Basic Test Notification
                        </button>
                        <button id="addSameUserResponse" class="bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700">
                            Add Response (Same User)
                        </button>
                        <button id="addOtherUserResponse" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
                            Add Response (Other User)
                        </button>
                    </div>
                </div>
                
                <!-- Check for Updates -->
                <div class="border-l-4 border-orange-500 pl-4">
                    <h3 class="font-semibold">4. Manual Update Check</h3>
                    <button id="checkForUpdates" class="mt-2 bg-orange-600 text-white px-4 py-2 rounded hover:bg-orange-700">
                        Check for Updates Now
                    </button>
                </div>
                
                <!-- Auto-check Toggle -->
                <div class="border-l-4 border-indigo-500 pl-4">
                    <h3 class="font-semibold">5. Auto-check (Every 10 seconds)</h3>
                    <button id="toggleAutoCheck" class="mt-2 bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">
                        Start Auto-check
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Log Output -->
        <div class="bg-gray-900 text-green-400 rounded-lg p-4">
            <h3 class="text-lg font-bold mb-2">üìù Console Log</h3>
            <div id="logOutput" class="text-xs font-mono h-64 overflow-y-auto whitespace-pre-wrap"></div>
        </div>
    </div>

    <script>
        const logOutput = document.getElementById('logOutput');
        let autoCheckInterval = null;
        let isAutoChecking = false;
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}\n`;
            logOutput.textContent += logMessage;
            logOutput.scrollTop = logOutput.scrollHeight;
            console.log(message);
        }
        
        // Check permission status
        document.getElementById('checkPermission').addEventListener('click', function() {
            const permission = Notification.permission;
            const status = document.getElementById('permissionStatus');
            status.textContent = `Current permission: ${permission}`;
            log(`Notification permission: ${permission}`);
            
            if (permission === 'granted') {
                status.className = 'mt-2 text-sm text-green-600 font-semibold';
            } else if (permission === 'denied') {
                status.className = 'mt-2 text-sm text-red-600 font-semibold';
            } else {
                status.className = 'mt-2 text-sm text-yellow-600 font-semibold';
            }
        });
        
        // Enable notifications
        document.getElementById('enableNotifications').addEventListener('click', function() {
            if (Notification.permission === 'default') {
                Notification.requestPermission().then(function(result) {
                    log(`Permission request result: ${result}`);
                    if (result === 'granted') {
                        log('‚úÖ Notifications enabled successfully!');
                    } else {
                        log('‚ùå Notification permission denied');
                    }
                });
            } else {
                log(`Permission already set to: ${Notification.permission}`);
            }
        });
        
        // Basic test notification
        document.getElementById('testBasicNotif').addEventListener('click', function() {
            if (Notification.permission === 'granted') {
                new Notification('Test Notification', {
                    body: 'This is a basic test notification',
                    icon: '/favicon.ico'
                });
                log('‚úÖ Basic test notification sent');
            } else {
                log('‚ùå Cannot send notification - permission not granted');
            }
        });
        
        // Add same user response (should NOT notify)
        document.getElementById('addSameUserResponse').addEventListener('click', function() {
            fetch('api/add_test_response.php?id=1&other_user=0')
                .then(response => {
                    if (response.status === 401) {
                        return response.json().then(data => {
                            log('‚ùå Authentication required for adding response');
                            throw new Error('Authentication required');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    log('üìù Same user response added - should NOT trigger notification');
                    log(`Response: ${JSON.stringify(data)}`);
                })
                .catch(error => {
                    log(`‚ùå Error adding same user response: ${error.message}`);
                });
        });
        
        // Add other user response (SHOULD notify)
        document.getElementById('addOtherUserResponse').addEventListener('click', function() {
            fetch('api/add_test_response.php?id=1&other_user=1')
                .then(response => {
                    if (response.status === 401) {
                        return response.json().then(data => {
                            log('‚ùå Authentication required for adding response');
                            throw new Error('Authentication required');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    log('üìù Other user response added - SHOULD trigger notification');
                    log(`Response: ${JSON.stringify(data)}`);
                })
                .catch(error => {
                    log(`‚ùå Error adding other user response: ${error.message}`);
                });
        });
        
        // Manual update check
        document.getElementById('checkForUpdates').addEventListener('click', function() {
            log('üîç Manually checking for updates...');
            checkForUpdates();
        });
        
        // Toggle auto-check
        document.getElementById('toggleAutoCheck').addEventListener('click', function() {
            const button = document.getElementById('toggleAutoCheck');
            
            if (isAutoChecking) {
                clearInterval(autoCheckInterval);
                isAutoChecking = false;
                button.textContent = 'Start Auto-check';
                button.className = 'mt-2 bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700';
                log('‚èπÔ∏è Auto-check stopped');
            } else {
                autoCheckInterval = setInterval(checkForUpdates, 10000); // Every 10 seconds
                isAutoChecking = true;
                button.textContent = 'Stop Auto-check';
                button.className = 'mt-2 bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700';
                log('‚ñ∂Ô∏è Auto-check started (every 10 seconds)');
            }
        });
        
        function checkForUpdates() {
            fetch('api/simple_check_updates.php?id=1')
                .then(response => {
                    if (response.status === 401) {
                        // Authentication required
                        return response.json().then(data => {
                            log('‚ùå Authentication required - please login first');
                            log(`Redirect to: ${data.redirect || 'login.php'}`);
                            throw new Error('Authentication required');
                        });
                    }
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    log('üì° Update check response:');
                    log(JSON.stringify(data, null, 2));
                    
                    if (data.hasUpdates) {
                        log('üîî NEW UPDATES DETECTED!');
                        if (Notification.permission === 'granted') {
                            new Notification('Ticket #1 - New Update', {
                                body: data.message || 'New activity detected',
                                icon: '/favicon.ico',
                                tag: 'ticket-1-update'
                            });
                            log('‚úÖ Notification sent for update');
                        } else {
                            log('‚ùå Cannot send notification - permission not granted');
                        }
                    } else {
                        log('‚ÑπÔ∏è No new updates found');
                    }
                })
                .catch(error => {
                    log(`‚ùå Update check failed: ${error.message}`);
                });
        }
        
        // Initialize
        log('üöÄ Notification test page loaded');
        log('Click "Check Permission Status" to begin');
    </script>
</body>
</html>