<!-- CLEAN CHAT SYSTEM - Copy this to replace the messy chat in view_ticket.php -->

<!-- Integrated Chat Interface -->
<div class="bg-white rounded-xl shadow-lg card-hover overflow-hidden">
    <!-- Chat Header -->
    <div class="bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-4">
        <h3 class="text-xl font-bold text-white flex items-center">
            <i class="fas fa-comments mr-3"></i>
            Conversation
            <span id="messageCount" class="ml-3 bg-blue-500 bg-opacity-50 px-3 py-1 rounded-full text-sm font-medium"><?= count($responses) ?></span>
        </h3>
    </div>
    
    <!-- Chat Messages Area -->
    <div id="chatContainer" class="h-96 overflow-y-auto p-4 bg-gray-50 space-y-3">
        <!-- Messages will be loaded here -->
        <div class="text-center py-16">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
            <p class="text-gray-500 mt-4">Loading messages...</p>
        </div>
    </div>
    
    <!-- Message Input -->
    <div class="border-t border-gray-200 bg-white p-4">
        <form id="chatForm" onsubmit="return false;">
            <div class="flex items-end space-x-3">
                <div class="flex-1">
                    <textarea 
                        name="message" 
                        id="messageInput" 
                        rows="2" 
                        class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all resize-none" 
                        placeholder="Type your message..."
                        required></textarea>
                </div>
                
                <?php if ($userType === 'it_staff'): ?>
                <div class="flex items-center">
                    <label class="inline-flex items-center text-sm">
                        <input type="checkbox" name="is_internal" id="isInternal" class="mr-2 rounded border-gray-300 text-orange-600 focus:ring-orange-500">
                        <span class="text-gray-700">Internal</span>
                    </label>
                </div>
                <?php endif; ?>
                
                <button type="submit" id="sendButton" class="bg-blue-600 text-white px-6 py-3 rounded-xl hover:bg-blue-700 transition-colors font-medium flex items-center">
                    <i class="fas fa-paper-plane mr-2"></i>
                    Send
                </button>
            </div>
        </form>
    </div>
</div>

<!-- CLEAN CHAT JAVASCRIPT -->
<script>
(function() {
    'use strict';
    
    const TICKET_ID = <?= $ticketId ?>;
    const USER_TYPE = '<?= $userType ?>';
    const USER_ID = <?= $_SESSION['user_id'] ?>;
    
    let chatContainer, messageInput, chatForm, sendButton;
    let isLoading = false;
    
    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        chatContainer = document.getElementById('chatContainer');
        messageInput = document.getElementById('messageInput');
        chatForm = document.getElementById('chatForm');
        sendButton = document.getElementById('sendButton');
        
        if (!chatContainer || !messageInput || !chatForm) {
            console.error('Chat elements not found');
            return;
        }
        
        console.log('âœ… Chat initialized');
        
        // Load initial messages
        loadMessages();
        
        // Handle form submission
        chatForm.addEventListener('submit', sendMessage);
        
        // Auto-refresh messages every 5 seconds
        setInterval(loadMessages, 5000);
        
        // Ctrl+Enter to send
        messageInput.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                sendMessage(e);
            }
        });
    });
    
    // Load messages from server
    function loadMessages() {
        if (isLoading) return;
        isLoading = true;
        
        fetch(`api/get_chat_messages.php?ticket_id=${TICKET_ID}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    renderMessages(data.messages);
                    updateMessageCount(data.total);
                } else {
                    showError(data.message || 'Failed to load messages');
                }
            })
            .catch(error => {
                console.error('Error loading messages:', error);
                showError('Network error loading messages');
            })
            .finally(() => {
                isLoading = false;
            });
    }
    
    // Render messages in chat container
    function renderMessages(messages) {
        if (!chatContainer) return;
        
        // Save scroll position
        const wasAtBottom = isScrolledToBottom();
        
        // Clear and render
        chatContainer.innerHTML = '';
        
        if (messages.length === 0) {
            chatContainer.innerHTML = `
                <div class="text-center py-16">
                    <i class="fas fa-comment-slash text-gray-400 text-4xl mb-3"></i>
                    <p class="text-gray-500">No messages yet</p>
                    <p class="text-gray-400 text-sm">Start the conversation!</p>
                </div>
            `;
            return;
        }
        
        messages.forEach(msg => {
            const messageEl = createMessageElement(msg);
            chatContainer.appendChild(messageEl);
        });
        
        // Auto-scroll if user was at bottom
        if (wasAtBottom) {
            scrollToBottom();
        }
    }
    
    // Create a message DOM element
    function createMessageElement(msg) {
        const div = document.createElement('div');
        const alignClass = msg.is_my_message ? 'justify-end' : 'justify-start';
        const bubbleClass = msg.is_my_message 
            ? 'bg-blue-500 text-white rounded-l-2xl rounded-tr-2xl' 
            : 'bg-green-100 border border-green-200 rounded-r-2xl rounded-tl-2xl text-gray-800';
        
        div.className = `flex ${alignClass} mb-4`;
        div.innerHTML = `
            <div class="max-w-xs">
                <div class="chat-bubble ${bubbleClass} px-4 py-3 shadow-sm">
                    <p class="text-sm leading-relaxed whitespace-pre-wrap">${escapeHtml(msg.message)}</p>
                    <div class="flex justify-between items-center mt-2">
                        <span class="text-xs opacity-75">${msg.formatted_time}</span>
                        ${msg.is_my_message ? `
                            <div class="flex items-center space-x-1">
                                <i class="fas fa-check${msg.is_seen ? '-double text-blue-300' : ''} text-xs"></i>
                            </div>
                        ` : ''}
                    </div>
                    ${msg.is_internal ? '<span class="text-xs bg-orange-500 bg-opacity-20 px-2 py-1 rounded-full mt-2 inline-block"><i class="fas fa-lock mr-1"></i>Internal</span>' : ''}
                </div>
            </div>
        `;
        return div;
    }
    
    // Send a new message
    function sendMessage(e) {
        e.preventDefault();
        
        const message = messageInput.value.trim();
        if (!message) return;
        
        const isInternal = document.getElementById('isInternal')?.checked || false;
        
        // Disable button
        sendButton.disabled = true;
        sendButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Sending...';
        
        const formData = new FormData();
        formData.append('ticket_id', TICKET_ID);
        formData.append('message', message);
        formData.append('is_internal', isInternal ? '1' : '0');
        
        fetch('api/add_response.php', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Clear input
                messageInput.value = '';
                if (document.getElementById('isInternal')) {
                    document.getElementById('isInternal').checked = false;
                }
                
                // Reload messages
                loadMessages();
                
                // Show success
                showSuccess('Message sent!');
            } else {
                showError(data.message || 'Failed to send message');
            }
        })
        .catch(error => {
            console.error('Error sending message:', error);
            showError('Network error sending message');
        })
        .finally(() => {
            // Re-enable button
            sendButton.disabled = false;
            sendButton.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Send';
        });
    }
    
    // Helper functions
    function scrollToBottom() {
        if (chatContainer) {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
    }
    
    function isScrolledToBottom() {
        if (!chatContainer) return true;
        return chatContainer.scrollTop >= (chatContainer.scrollHeight - chatContainer.offsetHeight - 50);
    }
    
    function updateMessageCount(count) {
        const countEl = document.getElementById('messageCount');
        if (countEl) {
            countEl.textContent = count;
        }
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function showSuccess(message) {
        showNotification(message, 'success');
    }
    
    function showError(message) {
        showNotification(message, 'error');
    }
    
    function showNotification(message, type) {
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${
            type === 'success' 
                ? 'bg-green-100 border border-green-400 text-green-700' 
                : 'bg-red-100 border border-red-400 text-red-700'
        }`;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => notification.remove(), 3000);
    }
    
})();
</script>
