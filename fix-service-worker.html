<!DOCTYPE html>
<html>
<head>
    <title>Fix Firebase Service Worker Registration</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { background: white; padding: 20px; margin: 15px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .success { color: #28a745; background: #d4edda; padding: 10px; border-radius: 5px; border-left: 4px solid #28a745; }
        .error { color: #dc3545; background: #f8d7da; padding: 10px; border-radius: 5px; border-left: 4px solid #dc3545; }
        .warning { color: #856404; background: #fff3cd; padding: 10px; border-radius: 5px; border-left: 4px solid #ffc107; }
        .info { color: #17a2b8; background: #d1ecf1; padding: 10px; border-radius: 5px; border-left: 4px solid #17a2b8; }
        button { background: #0D8ABC; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0a6d94; }
        button.danger { background: #dc3545; }
        button.danger:hover { background: #c82333; }
        button.success { background: #28a745; }
        button.success:hover { background: #218838; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px; }
        .step { margin: 15px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>üîß Fix Firebase Service Worker Registration</h1>
    
    <div class="container">
        <div class="warning">
            <h3>‚ö†Ô∏è Problem Detected:</h3>
            <p>Service worker is registered from old location: <code>/IThelp/firebase-messaging-sw.js</code></p>
            <p>Need to re-register from domain root: <code>/firebase-messaging-sw.js</code></p>
        </div>
    </div>

    <div class="container">
        <h2>üéØ Automatic Fix Process</h2>
        <p>Click the buttons below in order:</p>

        <div class="step">
            <h3>Step 1: Check Current Registration</h3>
            <button onclick="checkCurrentRegistrations()">üîç Check Current Status</button>
            <div id="current-status"></div>
        </div>

        <div class="step">
            <h3>Step 2: Unregister Old Service Worker</h3>
            <button class="danger" onclick="unregisterOldServiceWorker()">‚ùå Unregister Old SW</button>
            <div id="unregister-status"></div>
        </div>

        <div class="step">
            <h3>Step 3: Register New Service Worker</h3>
            <button class="success" onclick="registerNewServiceWorker()">‚úÖ Register New SW</button>
            <div id="register-status"></div>
        </div>

        <div class="step">
            <h3>Step 4: Verify Fix</h3>
            <button onclick="verifyFix()">üéØ Verify Registration</button>
            <div id="verify-status"></div>
        </div>
    </div>

    <div class="container">
        <h2>üìã Manual Instructions (Alternative)</h2>
        <div class="info">
            <h4>If automatic fix doesn't work:</h4>
            <ol>
                <li><strong>Clear browser cache:</strong> Ctrl+Shift+Del ‚Üí Clear all data</li>
                <li><strong>Open DevTools:</strong> F12 ‚Üí Application ‚Üí Service Workers</li>
                <li><strong>Unregister manually:</strong> Find old registration and click "Unregister"</li>
                <li><strong>Go to dashboard:</strong> <a href="dashboard.php">Enable notifications again</a></li>
            </ol>
        </div>
    </div>

    <script>
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'info';
            element.innerHTML = `<div class="${className}"><p>${message}</p></div>`;
        }

        async function checkCurrentRegistrations() {
            log('current-status', 'üîç Checking service worker registrations...', 'info');
            
            try {
                if ('serviceWorker' in navigator) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    
                    if (registrations.length === 0) {
                        log('current-status', 'üìã No service workers registered', 'warning');
                        return;
                    }

                    let html = '<h4>üìã Current Registrations:</h4>';
                    registrations.forEach((reg, index) => {
                        const scope = reg.scope;
                        const scriptURL = reg.active ? reg.active.scriptURL : 'Not active';
                        const state = reg.active ? reg.active.state : 'inactive';
                        
                        html += `<div style="margin:10px 0;padding:10px;border:1px solid #ddd;border-radius:5px;">`;
                        html += `<strong>Registration ${index + 1}:</strong><br>`;
                        html += `<strong>Script:</strong> ${scriptURL}<br>`;
                        html += `<strong>Scope:</strong> ${scope}<br>`;
                        html += `<strong>State:</strong> ${state}<br>`;
                        
                        if (scriptURL.includes('/IThelp/firebase-messaging-sw.js')) {
                            html += '<span style="color:#dc3545;">‚ùå OLD LOCATION - Need to fix</span>';
                        } else if (scriptURL.includes('/firebase-messaging-sw.js') && !scriptURL.includes('/IThelp/')) {
                            html += '<span style="color:#28a745;">‚úÖ CORRECT LOCATION</span>';
                        }
                        html += '</div>';
                    });
                    
                    document.getElementById('current-status').innerHTML = `<div class="info">${html}</div>`;
                } else {
                    log('current-status', '‚ùå Service workers not supported', 'error');
                }
            } catch (error) {
                log('current-status', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function unregisterOldServiceWorker() {
            log('unregister-status', '‚ùå Unregistering old service worker...', 'info');
            
            try {
                const registrations = await navigator.serviceWorker.getRegistrations();
                let unregistered = 0;
                
                for (const registration of registrations) {
                    const scriptURL = registration.active ? registration.active.scriptURL : '';
                    
                    // Unregister if it's the old IThelp location
                    if (scriptURL.includes('/IThelp/firebase-messaging-sw.js')) {
                        await registration.unregister();
                        unregistered++;
                        log('unregister-status', `‚úÖ Unregistered: ${scriptURL}`, 'success');
                    }
                }
                
                if (unregistered === 0) {
                    log('unregister-status', '‚ö†Ô∏è No old service workers found to unregister', 'warning');
                } else {
                    log('unregister-status', `‚úÖ Successfully unregistered ${unregistered} old service worker(s)`, 'success');
                }
                
            } catch (error) {
                log('unregister-status', `‚ùå Error unregistering: ${error.message}`, 'error');
            }
        }

        async function registerNewServiceWorker() {
            log('register-status', '‚úÖ Registering new service worker at domain root...', 'info');
            
            try {
                // First check if file exists at domain root
                const response = await fetch('/firebase-messaging-sw.js');
                if (!response.ok) {
                    log('register-status', '‚ùå Service worker file not found at domain root. Please copy firebase-messaging-sw.js to domain root first.', 'error');
                    return;
                }
                
                // Register new service worker
                const registration = await navigator.serviceWorker.register('/firebase-messaging-sw.js', {
                    scope: '/'
                });
                
                log('register-status', '‚úÖ New service worker registered successfully!<br>üìç Location: /firebase-messaging-sw.js<br>üåê Scope: / (entire domain)', 'success');
                
                // Wait for it to activate
                if (registration.installing) {
                    registration.installing.addEventListener('statechange', function() {
                        if (this.state === 'activated') {
                            log('register-status', 'üéâ New service worker is now active and ready!', 'success');
                        }
                    });
                }
                
            } catch (error) {
                log('register-status', `‚ùå Error registering new service worker: ${error.message}`, 'error');
            }
        }

        async function verifyFix() {
            log('verify-status', 'üéØ Verifying service worker fix...', 'info');
            
            try {
                const registrations = await navigator.serviceWorker.getRegistrations();
                
                let hasCorrectRegistration = false;
                let hasOldRegistration = false;
                
                registrations.forEach(reg => {
                    const scriptURL = reg.active ? reg.active.scriptURL : '';
                    
                    if (scriptURL.includes('/firebase-messaging-sw.js') && !scriptURL.includes('/IThelp/')) {
                        hasCorrectRegistration = true;
                    }
                    
                    if (scriptURL.includes('/IThelp/firebase-messaging-sw.js')) {
                        hasOldRegistration = true;
                    }
                });
                
                if (hasCorrectRegistration && !hasOldRegistration) {
                    log('verify-status', `
                        <h4>üéâ SUCCESS - Service Worker Fixed!</h4>
                        <p>‚úÖ Service worker now registered at domain root</p>
                        <p>‚úÖ No old registrations remaining</p>
                        <p>üéØ <strong>Next:</strong> <a href="test-rich-notifications.php">Test rich photo notifications</a></p>
                        <p>üì± Your notifications should now show user photos and action buttons!</p>
                    `, 'success');
                } else if (hasOldRegistration) {
                    log('verify-status', '‚ö†Ô∏è Old registration still exists. Try unregistering again or clear browser cache.', 'warning');
                } else if (!hasCorrectRegistration) {
                    log('verify-status', '‚ùå New registration not found. Make sure firebase-messaging-sw.js is copied to domain root.', 'error');
                } else {
                    log('verify-status', 'üîÑ Mixed state. Try clearing browser cache and repeat the process.', 'warning');
                }
                
            } catch (error) {
                log('verify-status', `‚ùå Error verifying: ${error.message}`, 'error');
            }
        }

        // Auto-check on load
        window.onload = function() {
            checkCurrentRegistrations();
        };
    </script>

    <div class="container">
        <h3>üéØ After Fixing:</h3>
        <p><strong>Test your rich photo notifications:</strong></p>
        <p><a href="test-rich-notifications.php" style="background:#28a745;color:white;padding:10px 15px;text-decoration:none;border-radius:5px;">üß™ Test Rich Notifications</a></p>
    </div>
</body>
</html>